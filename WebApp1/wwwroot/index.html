<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IAM Lab – Dashboard</title>
    <style>
        /* Base reset & typography */
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f4f8; color: #333; }
        a { color: inherit; text-decoration: none; }

        /* Header styling */
        header { display: flex; align-items: center; justify-content: space-between; background-color: #ffffff; padding: 0.5rem 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.5rem; font-weight: bold; color: #0056b3; }

        /* Navigation menu */
        nav { display: flex; align-items: center; gap: 1rem; }
        nav button { background: none; border: none; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; position: relative; }
        nav button:hover, nav button.active { color: #0056b3; }
        nav button.active::after { content: ""; position: absolute; left: 0; right: 0; bottom: 0; height: 3px; background-color: #0056b3; border-radius: 2px; }

        /* Toolbar right side */
        .toolbar-right { display: flex; align-items: center; gap: 1rem; }
        .toolbar-right select { padding: 0.4rem 0.6rem; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer; }
        .auth-btn { background-color: #0056b3; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .auth-btn.logout { background-color: #dc3545; }
        .auth-btn:hover { opacity: 0.9; }

        /* NEW: User Greeting Styling */
        .user-greeting {
            display: none; /* Hidden by default */
            font-weight: bold;
        }

        /* Main content */
        .container { max-width: 900px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #0056b3; }
        ul { padding-left: 1.2rem; }
        .actions { margin: 1rem 0; }
        button.primary { background-color: #0056b3; color: #fff; border: none; padding: 0.6rem 1rem; border-radius: 4px; cursor: pointer; }
        button.primary:hover { opacity: 0.9; }
        pre { background-color: #f7f9fc; padding: 1rem; border-radius: 4px; white-space: pre-wrap; word-break: break-all; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Profile styling */
        .profile-info { display: grid; grid-template-columns: max-content 1fr; gap: 0.5rem 1rem; }
        .profile-info dt { font-weight: bold; }
        .profile-info dd { margin: 0; word-break: break-all; }
		
        /* Footer note styling */
        footer { text-align: center; margin: 2rem 0; font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <header>
        <div class="logo">IAM Lab</div>
        <nav>
            <button class="tab-btn active" data-tab="apps">Applications</button>
            <button class="tab-btn" data-tab="profile">Profile</button>
            <button class="tab-btn" data-tab="users">Users & Roles</button>
            <button class="tab-btn" data-tab="architecture">Architecture</button>
        </nav>
        <div class="toolbar-right">
            <span id="user-greeting" class="user-greeting"></span>
            <select id="app-select">
                <option value="http://10.0.0.50:9101/">Web App 1</option>
                <option value="http://10.0.0.50:9102/">Web App 2</option>
            </select>
            <button id="auth-btn" class="auth-btn">Login</button>
        </div>
    </header>

    <main class="container">
        <!-- Applications -->
        <section id="apps" class="tab-content active">
            <h2>LOB Services</h2>
            <div class="actions">
                <button class="primary" onclick="calllob('lob1')">Call LOB 1</button>
                <button class="primary" onclick="calllob('lob2')">Call LOB 2</button>
                <button class="primary" onclick="calllob('lob3')">Call LOB 3</button>
            </div>
            <h2>API Response</h2>
            <pre id="api-result">No request yet.</pre>
        </section>

        <!-- Profile -->
        <section id="profile" class="tab-content">
            <h2>Profile</h2>
            <dl id="profile-info" class="profile-info">
                <dt>Username:</dt><dd id="info-username">—</dd>
                <dt>Email:</dt><dd id="info-email">—</dd>
                <dt>Email Verified:</dt><dd id="info-email-verified">—</dd>
                <dt>Roles:</dt><dd id="info-roles">—</dd>
                <dt>Subject ID (sub):</dt><dd id="info-sub">—</dd>
                <hr><hr>
                <dt>Issuer (iss):</dt><dd id="info-iss">—</dd>
                <dt>Audience (aud):</dt><dd id="info-aud">—</dd>
                <dt>Authorized Party (azp):</dt><dd id="info-azp">—</dd>
                <hr><hr>
                <dt>Authenticated at:</dt><dd id="info-auth-time">—</dd>
                <dt>Issued at (iat):</dt><dd id="info-iat">—</dd>
                <dt>Expires at (exp):</dt><dd id="info-exp">—</dd>
                <hr><hr>
                <dt>JWT ID (jti):</dt><dd id="info-jti">—</dd>
                <dt>Session ID (sid):</dt><dd id="info-sid">—</dd>
            </dl>
        </section>

        <!-- Users & Roles -->
        <section id="users" class="tab-content">
            <h2>Test Users and Roles</h2>
            <ul>
                <li><strong>alice</strong> / alice – Role: <code>lob1-user</code></li>
                <li><strong>bob</strong> / bob – Roles: <code>lob1-user</code>, <code>lob2-user</code></li>
                <li><strong>charlie</strong> / charlie – Roles: <code>lob1-user</code>, <code>lob2-user</code>, <code>lob3-user</code></li>
            </ul>
        </section>

        <!-- Architecture -->
        <section id="architecture" class="tab-content">
            <h2>Architecture & Flow</h2>
			
			<!-- SVG Diagram Start -->
			<svg width="100%" viewBox="0 0 3624 2382"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" overflow="hidden"><defs><linearGradient x1="3400.37" y1="1777.49" x2="3400.37" y2="1859.49" gradientUnits="userSpaceOnUse" spreadMethod="reflect" id="fill0"><stop offset="0" stop-color="#D09FC8"/><stop offset="0.5" stop-color="#C692BE"/><stop offset="1" stop-color="#C17EB6"/></linearGradient><linearGradient x1="3400.37" y1="1929.49" x2="3400.37" y2="2011.49" gradientUnits="userSpaceOnUse" spreadMethod="reflect" id="fill1"><stop offset="0" stop-color="#D09FC8"/><stop offset="0.5" stop-color="#C692BE"/><stop offset="1" stop-color="#C17EB6"/></linearGradient><linearGradient x1="3400.37" y1="2082.49" x2="3400.37" y2="2163.49" gradientUnits="userSpaceOnUse" spreadMethod="reflect" id="fill2"><stop offset="0" stop-color="#D09FC8"/><stop offset="0.5" stop-color="#C692BE"/><stop offset="1" stop-color="#C17EB6"/></linearGradient></defs><g transform="translate(-388 1)"><path d="M388.872-0.0107048 1063.87-0.0107048 1063.87 2380.99 388.872 2380.99Z" fill="#F0F4F8" fill-rule="evenodd"/><text fill="#A0A0A0" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 442.961 80)">User (Browser)</text><path d="M1094.87-0.0107048 4011.87-0.0107048 4011.87 2380.99 1094.87 2380.99Z" fill="#F0F4F8" fill-rule="evenodd"/><text fill="#A0A0A0" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1722.25 80)">-</text><text fill="#A0A0A0" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1303.42 82)">Server Side </text><text fill="#A0A0A0" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1608.74 82)">Network: </text><text fill="#A0A0A0" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1865.61 82)">iam_lab_net</text><path d="M452.372 1069.49 1003.37 1069.49 1003.37 1313.49 452.372 1313.49Z" stroke="#333333" stroke-width="4.78579" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd"/><text fill="#0056B3" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 623.554 1157)">User</text><text fill="#555555" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="400" font-size="55" transform="matrix(1 0 0 1 632.327 1237)">Browser</text><path d="M1219.37 1069.49 1771.37 1069.49 1771.37 1313.49 1219.37 1313.49Z" stroke="#333333" stroke-width="4.78579" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd"/><text fill="#0056B3" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1319.7 1157)">Web App (BFF)</text><text fill="#555555" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="400" font-size="55" transform="matrix(1 0 0 1 1300.68 1247)">Port: 9101 / 9102</text><path d="M1895.37 215.489 2508.37 215.489 2508.37 489.489 1895.37 489.489Z" stroke="#333333" stroke-width="4.78579" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd"/><text fill="#0056B3" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2097.14 302)">Keycloak</text><text fill="#555555" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="400" font-size="55" transform="matrix(1 0 0 1 1917.1 379)">Identity &amp; Access </text><text fill="#555555" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="400" font-size="55" transform="matrix(1 0 0 1 2351.95 379)">Mgmt</text><text fill="#555555" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="400" font-size="55" transform="matrix(1 0 0 1 2086 453)">Port: 9100</text><path d="M1895.37 1832.49 2508.37 1832.49 2508.37 2107.49 1895.37 2107.49Z" stroke="#333333" stroke-width="4.78579" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd"/><text fill="#0056B3" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1985.06 1920)">Kong API Gateway</text><text fill="#555555" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="400" font-size="55" transform="matrix(1 0 0 1 1995.39 2002)">OIDC, ACL, Proxy</text><text fill="#555555" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="400" font-size="55" transform="matrix(1 0 0 1 2074.49 2071)">Port: 9180</text><path d="M3088.37 1619.49 3763.37 1619.49 3763.37 2290.49 3088.37 2290.49Z" stroke="#333333" stroke-width="4.78579" stroke-miterlimit="8" fill="#FFFFFF" fill-rule="evenodd"/><text fill="#0056B3" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3130.62 1726)">LOB Backend Services</text><path d="M3149.37 1777.49 3651.37 1777.49 3651.37 1859.49 3149.37 1859.49Z" stroke="#A02B93" stroke-width="4.72661" stroke-miterlimit="8" fill="url(#fill0)" fill-rule="evenodd"/><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3328.79 1842)">LOB</text><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3432.83 1842)">-</text><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3455.17 1842)">1</text><path d="M3149.37 1929.49 3651.37 1929.49 3651.37 2011.49 3149.37 2011.49Z" stroke="#A02B93" stroke-width="4.72661" stroke-miterlimit="8" fill="url(#fill1)" fill-rule="evenodd"/><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3328.79 1995)">LOB</text><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3432.83 1995)">-</text><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3455.17 1995)">2</text><path d="M3149.37 2082.49 3651.37 2082.49 3651.37 2163.49 3149.37 2163.49Z" stroke="#A02B93" stroke-width="4.72661" stroke-miterlimit="8" fill="url(#fill2)" fill-rule="evenodd"/><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3328.79 2147)">LOB</text><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3432.83 2147)">-</text><text font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 3455.17 2147)">3</text><path d="M1113.87 1098.99C1113.87 1100.65 1112.53 1101.99 1110.87 1101.99 1109.21 1101.99 1107.87 1100.65 1107.87 1098.99 1107.87 1097.33 1109.21 1095.99 1110.87 1095.99 1112.53 1095.99 1113.87 1097.33 1113.87 1098.99Z" fill="#007BFF" fill-rule="evenodd"/><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1024.43 1057)">Login</text><path d="M1880.87 792.989C1880.87 794.646 1879.53 795.989 1877.87 795.989 1876.21 795.989 1874.87 794.646 1874.87 792.989 1874.87 791.332 1876.21 789.989 1877.87 789.989 1879.53 789.989 1880.87 791.332 1880.87 792.989Z" fill="#007BFF" fill-rule="evenodd"/><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(0.657138 -0.75377 0.75377 0.657138 1727.18 998)">Redirect to</text><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(0.657138 -0.75377 0.75377 0.657138 1922.53 774)">Keycloak</text><path d="M1159.87 686.989C1159.87 688.646 1158.53 689.989 1156.87 689.989 1155.21 689.989 1153.87 688.646 1153.87 686.989 1153.87 685.332 1155.21 683.989 1156.87 683.989 1158.53 683.989 1159.87 685.332 1159.87 686.989Z" fill="#007BFF" fill-rule="evenodd"/><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1132.47 484)">Username + Password</text><path d="M1282.87 426.989C1282.87 428.646 1281.53 429.989 1279.87 429.989 1278.21 429.989 1276.87 428.646 1276.87 426.989 1276.87 425.332 1278.21 423.989 1279.87 423.989 1281.53 423.989 1282.87 425.332 1282.87 426.989Z" fill="#007BFF" fill-rule="evenodd"/><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1086.2 309)">Redirect with </text><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1442.69 309)">Auth</text><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1569.31 309)">Code</text><path d="M1697.87 716.989C1697.87 718.646 1696.3 719.989 1694.37 719.989 1692.44 719.989 1690.87 718.646 1690.87 716.989 1690.87 715.332 1692.44 713.989 1694.37 713.989 1696.3 713.989 1697.87 715.332 1697.87 716.989Z" fill="#007BFF" fill-rule="evenodd"/><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 974.715 756)">Exchange Code for Tokens</text><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1051.48 843)">(Back</text><text fill="#007BFF" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1193.36 843)">channel)</text><path d="M1113.87 1281.99C1113.87 1283.65 1112.53 1284.99 1110.87 1284.99 1109.21 1284.99 1107.87 1283.65 1107.87 1281.99 1107.87 1280.33 1109.21 1278.99 1110.87 1278.99 1112.53 1278.99 1113.87 1280.33 1113.87 1281.99Z" fill="#28A745" fill-rule="evenodd"/><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 850.673 1403)">API</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 940.621 1403)">-</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 962.965 1403)">Call (</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1093.02 1403)">e.g</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1186.4 1403)">LOB</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1290.44 1403)">-</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1312.79 1403)">1)</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1405.97 1362)">-</text><path d="M1727.87 1617.99C1727.87 1619.65 1726.3 1620.99 1724.37 1620.99 1722.44 1620.99 1720.87 1619.65 1720.87 1617.99 1720.87 1616.33 1722.44 1614.99 1724.37 1614.99 1726.3 1614.99 1727.87 1616.33 1727.87 1617.99Z" fill="#28A745" fill-rule="evenodd"/><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1338.75 1652)">Proxy to Kong with</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1326.66 1755)">Bearer Access Token</text><path d="M2201.37 1832.49C2201.37 1191.51 2201.37 581.058 2201.37 489.489" stroke="#6C757D" stroke-width="4.78579" stroke-miterlimit="8" stroke-dasharray="49.9712 24.9857" fill="none" fill-rule="evenodd"/><path d="M2279.87 1159.49C2279.87 1161.42 2278.53 1162.99 2276.87 1162.99 2275.21 1162.99 2273.87 1161.42 2273.87 1159.49 2273.87 1157.56 2275.21 1155.99 2276.87 1155.99 2278.53 1155.99 2279.87 1157.56 2279.87 1159.49Z" fill="#28A745" fill-rule="evenodd"/><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2242.1 1116)">Token</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2398.72 1118)">-</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2421.66 1118)">Introspection</text><path d="M2786.87 1968.99C2786.87 1970.65 2785.53 1971.99 2783.87 1971.99 2782.21 1971.99 2780.87 1970.65 2780.87 1968.99 2780.87 1967.34 2782.21 1965.99 2783.87 1965.99 2785.53 1965.99 2786.87 1967.34 2786.87 1968.99Z" fill="#28A745" fill-rule="evenodd"/><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2460.63 1984)">OK (</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="46" transform="matrix(1 0 0 1 2572.92 1984)">OIDC</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2684.64 1984)">+ACL validated)</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2527.15 1907)">Request forwarded</text><path d="M2172.87 1495.99C2172.87 1497.65 2171.53 1498.99 2169.87 1498.99 2168.21 1498.99 2166.87 1497.65 2166.87 1495.99 2166.87 1494.33 2168.21 1492.99 2169.87 1492.99 2171.53 1492.99 2172.87 1494.33 2172.87 1495.99Z" fill="#28A745" fill-rule="evenodd"/><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 1885.38 1454)">Data</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2026.29 1454)">-</text><text fill="#28A745" font-family="Segoe UI,Segoe UI_MSFontService,sans-serif" font-weight="700" font-size="55" transform="matrix(1 0 0 1 2062.58 1452)">Response back to user</text><path d="M6.82243 9.18918 4.71649 9.18918 9.26489 4.6671 9.26489 632.579 4.71649 628.056 996.429 628.056 996.429 637.101 0.168434 637.101 0.168434 0.145016 6.82243 0.145016ZM991.88 619.013 1019.17 632.579 991.88 646.145Z" fill="#0F9ED5" fill-rule="evenodd" transform="matrix(1 0 0 -1 857 1056)"/><path d="M0.0694591 0.117194 1304.06 0.117194 1304.58 717.624 1295.49 717.631 1294.97 4.64802 1299.51 9.17227 0.0694591 9.17227ZM1313.07 711.573 1302.65 740.117 1285.96 714.686Z" fill="#0F9ED5" fill-rule="evenodd" transform="matrix(-1 1.22465e-16 1.22465e-16 1 1894 329)"/><path d="M7.28354 0.178716 464.003 526.13 457.13 532.039 0.410902 6.08702ZM467.906 516.802 475.411 546.179 447.288 534.527Z" fill="#0F9ED5" fill-rule="evenodd" transform="matrix(1 0 0 -1 1555 1055)"/><path d="M7.25731 0.178027 462.976 526.109 456.085 532.006 0.365261 6.07467ZM466.901 516.788 474.366 546.178 446.226 534.478Z" fill="#0F9ED5" fill-rule="evenodd" transform="matrix(-1 1.22465e-16 1.22465e-16 1 1897 506)"/><path d="M1000.87 1135.99 1195.13 1135.99 1195.13 1144.99 1000.87 1144.99ZM1190.58 1126.99 1217.87 1140.49 1190.58 1153.99Z" fill="#0F9ED5" fill-rule="evenodd"/><path d="M1023.62 1217.99 1195.13 1217.99 1195.13 1226.99 1023.62 1226.99ZM1028.17 1235.99 1000.87 1222.49 1028.17 1208.99ZM1190.58 1208.99 1217.87 1222.49 1190.58 1235.99Z" fill="#4EA72E" fill-rule="evenodd"/><path d="M1716.97 1371.99 1908.52 1741.83 1900.43 1745.96 1708.87 1376.13ZM1914.53 1733.69 1914.87 1763.99 1890.25 1746.08Z" fill="#4EA72E" fill-rule="evenodd"/><path d="M1968.74 1740.99 1777.07 1363.25 1785.19 1359.17 1976.87 1736.9ZM1771 1371.38 1770.87 1340.99 1795.36 1359.13Z" fill="#4EA72E" fill-rule="evenodd"/><path d="M2509.87 2005.99 3036.15 2005.99 3036.15 2014.99 2509.87 2014.99ZM3031.61 1996.99 3058.87 2010.49 3031.61 2023.99Z" fill="#4EA72E" fill-rule="evenodd"/><path d="M3059.82 2066.49 2530.6 2063.63 2530.65 2054.31 3059.87 2057.16ZM2535.11 2072.99 2507.87 2058.85 2535.25 2044.99Z" fill="#4EA72E" fill-rule="evenodd"/></g></svg>
			<!-- SVG Diagram End -->

			<ol>
				<li><strong>Login:</strong> The user initiates the login in the Web App (BFF).</li>
				<li><strong>OIDC Redirect:</strong> The Web App redirects the browser to Keycloak (OIDC Authorization Code Flow with PKCE).</li>
				<li><strong>Authentication:</strong> The user enters their credentials at Keycloak.</li>
				<li><strong>Authorization Code:</strong> Keycloak redirects the browser back to the Web App with a one-time code.</li>
				<li><strong>Token Exchange:</strong> The Web App securely exchanges this code in the background for ID and Access Tokens from Keycloak. The tokens are stored in a server-side session.</li>
				<li><strong>API Call:</strong> The user invokes a protected function, e.g., "Call LOB 1". The browser sends the request to the Web App (BFF).</li>
				<li><strong>Proxy with Token:</strong> The Web App retrieves the Access Token from the session and forwards the request to the Kong API Gateway, including the token in the `Authorization` header.</li>
				<li><strong>Validation at Kong:</strong>
					<ul>
						<li>The <strong>OIDC Plugin</strong> in Kong intercepts the request and validates the Access Token with Keycloak (via Introspection).</li>
						<li>The <strong>ACL Plugin</strong> checks if the roles contained in the token (e.g., `lob1-user`) are authorized to access the requested path (`/lob1`).</li>
					</ul>
				</li>
				<li><strong>Access to Service:</strong> If validation is successful, Kong forwards the request to the corresponding backend LOB service.</li>
				<li><strong>Response:</strong> The LOB service processes the request and sends data back to the user via the same path. If authorization failed, Kong would send a `403 Forbidden` error.</li>
			</ol>
		</section>
    </main>
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Application selection
        document.getElementById('app-select').addEventListener('change', e => {
            window.location.href = e.target.value;
        });

        const authBtn = document.getElementById('auth-btn');
        const greetingElement = document.getElementById('user-greeting');
        let loggedIn = false;

        authBtn.addEventListener('click', () => {
            window.location.href = loggedIn ? '/logout' : '/login';
        });

        // Helpers
        const V = v => Array.isArray(v) ? v[0] : v; // first value if array
        const J = v => { // parse JSON string to object (if needed)
            if (v == null) return null;
            if (typeof v === 'string') {
                try { return JSON.parse(v); } catch { return null; }
            }
            return v;
        };
        function formatTimestamp(ts) {
            const n = Number(V(ts));
            if (!n) return '—';
            // Changed to en-US for English formatting
            return new Date(n * 1000).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'long' });
        }

        async function init() {
            try {
                const res = await fetch('/user', { cache: 'no-store' });
                if (!res.ok) {
                    loggedIn = false;
                    authBtn.textContent = 'Login';
                    authBtn.classList.remove('logout');
                    greetingElement.style.display = 'none';
                    return;
                }

                const u = await res.json(); // ID token payload JSON (or claims)
                loggedIn = true;
                authBtn.textContent = 'Logout';
                authBtn.classList.add('logout');

                // Greeting
                const username = V(u.preferred_username) || V(u.name) || 'User';
                greetingElement.textContent = `Hello, ${username}!`;
                greetingElement.style.display = 'inline';

                // realm_access.roles normalization
                let rolesText = '—';
                let realmAccess = J(u.realm_access) || u.realm_access || null;
                if (realmAccess && Array.isArray(realmAccess.roles)) {
                    rolesText = realmAccess.roles.join(', ') || '—';
                }

                // Populate profile
                document.getElementById('info-username').textContent = username || '—';
                document.getElementById('info-email').textContent = V(u.email) || '—';
                // Convert boolean string to Yes/No
                document.getElementById('info-email-verified').textContent =
                    (String(V(u.email_verified)).toLowerCase() === 'true') ? 'Yes' : 'No';
                document.getElementById('info-roles').textContent = rolesText;
                document.getElementById('info-sub').textContent = V(u.sub) || '—';

                document.getElementById('info-iss').textContent = V(u.iss) || '—';
                const aud = (Array.isArray(u.aud) ? u.aud.join(', ') : V(u.aud)) || '—';
                document.getElementById('info-aud').textContent = aud;
                document.getElementById('info-azp').textContent = V(u.azp) || '—';

                document.getElementById('info-auth-time').textContent = formatTimestamp(u.auth_time);
                document.getElementById('info-iat').textContent = formatTimestamp(u.iat);
                document.getElementById('info-exp').textContent = formatTimestamp(u.exp);

                document.getElementById('info-jti').textContent = V(u.jti) || '—';
                document.getElementById('info-sid').textContent = V(u.sid) || '—';
            } catch (e) {
                console.error('Error fetching user data:', e);
                document.getElementById('api-result').textContent =
                    'Error fetching user data. Is the backend reachable?';
                greetingElement.style.display = 'none';
                loggedIn = false;
                authBtn.textContent = 'Login';
                authBtn.classList.remove('logout');
            }
        }

        // lob calls
        async function calllob(lob) {
            const result = document.getElementById('api-result');
            result.textContent = `Calling /api/call-${lob}...`;

            try {
                const r = await fetch(`/api/call-${lob}`, {
                    cache: 'no-store'
                });

                if (!r.ok) {
                    throw new Error(`HTTP error! Status: ${r.status} ${r.statusText}`);
                }

                const text = await r.text();
                try {
                    const data = JSON.parse(text);
                    result.textContent = JSON.stringify(data, null, 2);
                } catch {
                    result.textContent = text;
                }

            } catch (e) {
                console.error('An error occurred:', e); 
                result.textContent = `Error: ${e.message}`;
            }
        }
        window.calllob = calllob;

        init();
    </script>

    <footer>Created by Vahid Tavakkoli 2025 for testing</footer>
</body>
</html>